<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
    <meta charset="UTF-8" content="text/html"/>
    <!--<meta name="_csrf" th:content="${_csrf.token}"/>-->
    <!--<meta name="_csrf_header" th:content="${_csrf.headerName}"/>-->
    <title>Maps</title>

    <!--WORKING IN SITE-->
    <link rel="stylesheet"  th:href="@{/webjars/bootstrap/3.3.7/css/bootstrap.min.css}"
          type="text/css" media="screen" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>

    <script type="text/javascript"
            src="/webjars/bootstrap/3.3.7/js/bootstrap.min.js"
            th:src="@{/webjars/bootstrap/3.3.7/js/bootstrap.min.js}"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/simple-left-sidebar.css}"
          href="/static/css/simple-left-sidebar.css" type="text/css" media="screen" />

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>

    <!--STYLES FOR WRAPPED MENU-->
    <style th:inline="text">
        .sidebar-wrapper {
            z-index: 1000;
            position: fixed;
            top:0;
            width: 30%;
            height: 100%;
            overflow-y: auto;
            background: #222;
            -webkit-transition: all 0.4s ease-in-out 0s;
            -moz-transition: all 0.4s ease-in-out 0s;
            -ms-transition: all 0.4s ease-in-out 0s;
            -o-transition: all 0.4s ease-in-out 0s;
            transition: all 0.4s ease-in-out 0s;
        }
        .sidebar-nav {
            position: absolute;
            top: 8.2%;
            width: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .sidebar-nav li {
            position: relative;
            line-height: 20px;
            display: inline-block;
            width: 100%;
            font-size: 110%;
            font-weight: 800;
            text-transform: uppercase;
            outline: none;
        }
        .sidebar-nav li:before {
            content: '';
            position: absolute;
            top: 0;
            z-index: -1;
            height: 100%;
            width: 3px;
            background-color: #1c1c1c;
            -webkit-transition: width .4s ease-in-out;
            -moz-transition: width .4s ease-in-out;
            -ms-transition: width .4s ease-in-out;
            transition: width .4s ease-in-out;
        }
        .sidebar-nav li:first-child a {
            color: #fff;
            background-color: #1a1a1a;
        }
        .sidebar-nav li:nth-child(2):before {
            color: #fff;
            background-color: #1a1a1a;
        }
        .sidebar-nav li:nth-child(3):before {
            background-color: #ec1b5a;
        }
        .sidebar-nav li:nth-child(4):before {
            background-color: #79aefe;
        }
        .sidebar-nav li:nth-child(5):before {
            background-color: #314190;
        }
        .sidebar-nav li:nth-child(6):before {
            background-color: #279636;
        }
        .sidebar-nav li:nth-child(7):before {
            background-color: #7d5d81;
        }
        .sidebar-nav li:nth-child(8):before {
            background-color: #ead24c;
        }
        .sidebar-nav li:nth-child(9):before {
            background-color: #2d2366;
        }
        .sidebar-nav li:nth-child(10):before {
            background-color: #35acdf;
        }
        .sidebar-nav li:hover:before, .sidebar-nav li.open:hover:before {
            width: 100%;
            -webkit-transition: width .4s ease-in-out;
            -moz-transition: width .4s ease-in-out;
            -ms-transition: width .4s ease-in-out;
            transition: width .4s ease-in-out;
        }
        .sidebar-nav li a {
            display: block;
            color: #ddd;
            text-decoration: none;
            padding: 10px 15px 10px 30px;
        }
        .sidebar-nav li a:hover, .sidebar-nav li a:active, .sidebar-nav li a:focus, .sidebar-nav li.open a:hover, .sidebar-nav li.open a:active, .sidebar-nav li.open a:focus {
            color: #fff;
            text-decoration: none;
            background-color: transparent;
        }
        .sidebar-nav > .sidebar-brand {
            height: 44px;
            font-size: 18px;
            line-height: 1.43;
        }
        .sidebar-nav .dropdown-menu {
            position: relative;
            width: 100%;
            padding: 0;
            margin: 0;
            border-radius: 0;
            border: none;
            background-color: #222;
            box-shadow: none;
        }
        .menu-toggle{
            z-index: 801;
            /*position: fixed;*/
            /*top: 0;*/
            /*left: .5%;*/
        }
        .sidebar-wrapper.active {
            -webkit-transition: all 0.4s ease 0s;
            -moz-transition: all 0.4s ease 0s;
            -ms-transition: all 0.4s ease 0s;
            -o-transition: all 0.4s ease 0s;
            transition: all 0.4s ease 0s;
        }
        .toggle {
            margin: 0;
        }
        .btn-dark {
            border-radius: 0;
            color: #fff;
            background-color: rgba(0,  0,  0,  0.4);
        }
        .btn-dark:hover, .btn-dark:focus, .btn-dark:active {
            color: #fff;
            background-color: rgba(0,  0,  0,  0.7);
        }
        .btn-light {
            border-radius: 0;
            color: #333;
            background-color: rgb(255,  255,  255);
        }
        .btn-light:hover, .btn-light:focus, .btn-light:active {
            color: #333;
            background-color: rgba(255,  255,  255,  0.8);
        }
        .btn {
            border-radius: 0px;
            overflow: hidden;
            border:none;
        }
        .btn-success:hover, .btn-success:focus, .btn-success.focus, .btn-success:active, .btn-success.active, .open > .dropdown-toggle.btn-success {
            color: #fff;
            background-color: #449d44;
            border-color: #398439;
            box-shadow: inset 0 0 0 2px #398439;
        }
        .btn-danger:hover, .btn-danger:focus, .btn-danger.focus, .btn-danger:active, .btn-danger.active, .open > .dropdown-toggle.btn-danger {
            color: #fff;
            background-color: #c9302c;
            border-color: #ac2925;
            box-shadow: inset 0 0 0 2px #ac2925;
        }
        .btn-primary:hover, .btn-primary:focus, .btn-primary.focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary {
            color: #fff;
            background-color: #286090;
            border-color: #204d74;
            box-shadow: inset 0 0 0 2px #204d74;
        }
        .btn-default {
            color: #333;
            background-color: #efefef;
            border-color: #ccc;
        }
        .btn-default:hover, .btn-default:focus, .btn-default.focus, .btn-default:active, .btn-default.active, .open > .dropdown-toggle.btn-default {
            color: #333;
            background-color: #e6e6e6;
            border-color: #adadad;
            box-shadow: inset 0 0 0 5px #adadad;
        }
        .btn-inverse {
            background-color: #222;
            border-color: #080808;
            color: #9d9d9d;
        }
        .btn-inverse:hover, .btn-inverse:focus, .btn-inverse.focus, .btn-inverse:active, .btn-inverse.active, .open > .dropdown-toggle.btn-inverse {
            color: #fff;
            background-color: #080808;
            border-color: #333;
            box-shadow: inset 0 0 0 2px #333;
        }
        .btn-danger:hover, .btn-danger:focus, .btn-danger.focus, .btn-danger:active, .btn-danger.active, .open > .dropdown-toggle.btn-danger {
            color: #fff;
            background-color: #c9302c;
            border-color: #ac2925;
            box-shadow: inset 0 0 0 2px #ac2925;
        }
        .btn-danger.active, .btn-danger.focus, .btn-danger:active, .btn-danger:focus, .btn-danger:hover, .open>.dropdown-toggle.btn-danger {
            color: #c9302c;
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #c9302c;
            border-color: #ac2925;
        }
        .btn-dark{
            border-radius: 0;
            color: #fff;
            background-color: rgba(0,0,0,0.4);
        }
        .btn-dark:hover,
        .btn-dark:focus,
        .btn-dark:active,
        .btn-dark.active{
            color: #fff;
            background-color: rgba(0,0,0,0.7);
        }

        /********************************/
        /*          Custom Buttons      */
        /********************************/
        .btn.btn-lg {padding: 10px 40px;}

    </style>

    <!--STYLES FOR RIGHT MENU-->
    <style th:inline="text">
        #sidebar-wrapper-right{
            position: fixed;
            top:0;
            /*width: 30%;*/
            /*height: 100%;*/
            right: 0;
            margin-right: -30%;
        }
        .wrapper-right li:before {
            right: 0;
        }
        #sidebar-wrapper-right.active {
            right: 30%;
            width: 30%;
        }
        #right-menu-toggle {
            position: fixed;
            top: 0;
            right: .5%;
        }
    </style>

    <!--STYLES FOR LEFT MENU-->
    <style th:inline="text">
        #sidebar-wrapper-left{
            position: fixed;
            top:0;
            /*width: 30%;*/
            /*height: 100%;*/
            left: 0;
            margin-left: -30%;
        }
        .wrapper-left li:before {
            left: 0;
        }
        #sidebar-wrapper-left.active {
            left: 30%;
            width: 30%;
        }
        #left-menu-toggle {
            position: fixed;
            top: 0;
            left: .5%;
        }
    </style>

    <!--STYLES FOR MAP-->
    <style th:inline="text">
        #map {
            width: 100%;
            height: 100%
        }
        .main-container {
            display: block;
            position: relative;
            width: 90%;
            height: 100%;
            /*padding-right: 15px;*/
            /*padding-left: 15px;*/
            padding-top: 50px;
            margin-right: auto;
            margin-left: auto;

            overflow: hidden;
        }
        /*@media (min-width: 768px) {*/
        /*.main-container {*/
        /*width: 750px*/
        /*}*/
        /*}*/
        /*@media (min-width: 992px) {*/
        /*.main-container {*/
        /*width: 970px*/
        /*}*/
        /*}*/
        /*@media (min-width: 1200px) {*/
        /*.main-container {*/
        /*width: 1170px*/
        /*}*/
        /*}*/
    </style>

    <!--STYLES FOR MESSAGES-->
    <style th:inline="text">
        #responseMessage {
            background-color: #fff;
            color: #0074D9;
        }
        #message-add_place {
            background-color: #0074D9;
            color: #fff;
        }
        .Message {
            display: table;
            position: fixed;
            /*left:0;*/
            left:calc(50% - 250px);
            bottom: 1em;
            margin: 0 auto;
            /*margin: 40px auto 0;*/
            width: 500px;
            -webkit-transition: all 0.4s ease;
            transition: all 0.4s ease;
            -webkit-animation: opacity 0.5s ease-out;
            -moz-animation: opacity 0.5s ease-out;
            -o-animation: opacity 0.5s ease-out;
            animation: opacity 0.5s ease-out;
        }
        .Message.is-hidden {
            opacity: 0;
            height: 0;
            margin-bottom: -250px;
            font-size: 0;
            padding: 0;
            /*margin: 0 auto;*/
            display: block;
            -webkit-transition: all 0.4s ease;
            transition: all 0.4s ease;
            -webkit-animation: opacity 0.5s ease-out;
            -moz-animation: opacity 0.5s ease-out;
            -o-animation: opacity 0.5s ease-out;
            animation: opacity 0.5s ease-out;
        }
        .Message-icon {
            display: table-cell;
            vertical-align: middle;
            width: 60px;
            padding: 30px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.25);
        }
        .Message-icon > i {
            width: 20px;
            font-size: 20px;
        }

        .Message-body {
            display: table-cell;
            vertical-align: middle;
            padding: 30px 20px 30px 10px;
        }
        .Message-body > p {
            line-height: 1.2;
            margin-top: 6px;
        }

        .Message-button {
            position: relative;
            margin: 15px 5px -10px;
            background-color: rgba(0, 0, 0, 0.25);
            box-shadow: 0 3px rgba(0, 0, 0, 0.4);
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-family: 'Source Sans Pro';
            color: #fff;
            outline: none;
            cursor: pointer;
        }
        .Message-button:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        .Message-button:active {
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0px rgba(0, 0, 0, 0.4);
            top: 3px;
        }

        .Message-close {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: none;
            outline: none;
            font-size: 20px;
            right: 5px;
            top: 5px;
            opacity: 0;
            cursor: pointer;
        }
        .Message:hover .Message-close {
            opacity: 1;
        }
        .Message-close:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .u-italic {
            font-style: italic;
        }
    </style>

    <!--STYLES FOR CHANGING FORMS IN RIGHT MENU-->
    <style th:inline="text">
        .geo_point-button {
            width:49%;
        }

        #geoPointListBlock>ul {
            color: #fff;
        }
    </style>

</head>
<body>

<!--HEADER-->
<div th:replace="fragments/header :: header"> </div>
<!--MAIN MAP CONTAINER-->
<div class="main-container">

    <!--yMaps-->
    <div id="map" style="width: 90vw; height: 90vh"></div>
    <!--<div id="map" style="position: relative;display: block;width: 100%; height: 100%"></div>-->

    <!--<th:block layout:fragment="script">-->
    <!--<script  type="text/javascript" src="ymaps.js" th:src="@{/js/ymaps.js}"></script>-->
    <!--</th:block>-->

    <script  type="text/javascript" th:src="@{/js/ymaps.js}" src="/static/js/ymaps.js"></script>

    <!--OBJECTS TO MAP-->
    <script th:inline="javascript">
        /*<![CDATA[*/
        /*twirl#houseIcon
        * twirl#darkgreenDotIcon*/
        var groups = [
            {
                name: "GeoPoints",
                style: 'islands#blueIcon',
                styleCircle: {
                    // Прозрачность заливки.
                    fillColor: "#84bfe2",
                    // Прозрачность заливки.
                    fillOpacity: 0.3,
                    // Цвет обводки.
                    strokeColor: "#72b5c2",
                    // Прозрачность обводки.
                    strokeOpacity: 0.5,
                    // Ширина обводки в пикселях.
                    strokeWidth: 1
                },
                items: [
                    {
                        id:1,
                        descr: 'Тестовая точка м.Адмиралтейская',
                        latitude: 59.93674,
                        longitude: 30.3117,
                        radius: 200
                    },
                    {
                        id:2,
                        descr: 'Тестовая точка м.Пл.А.Невского',
                        latitude: 59.925544,
                        longitude: 30.389422,
                        radius: 80
                    }
                ],
                placemarkCollection: null,
                circleCollection: null
            },
            /*twirl#bankIcon
            * twirl#whiteDotIcon*/
            {
                name: "TasksOwner",
                style: 'islands#yellowIcon',
                styleCircle: {
                    // Прозрачность заливки.
                    fillColor: "#ecf071",
                    // Прозрачность заливки.
                    fillOpacity: 0.3,
                    // Цвет обводки.
                    strokeColor: "#efed15",
                    // Прозрачность обводки.
                    strokeOpacity: 0.5,
                    // Ширина обводки в пикселях.
                    strokeWidth: 1
                },
                items: [
                ],
                placemarkCollection: null,
                circleCollection: null
            },
            {
                name: "TasksLocal",
                style: 'islands#redIcon',
                styleCircle: {
                    // Прозрачность заливки.
                    fillColor: "#f0a85c",
                    // Прозрачность заливки.
                    fillOpacity: 0.3,
                    // Цвет обводки.
                    strokeColor: "#ef8a6f",
                    // Прозрачность обводки.
                    strokeOpacity: 0.5,
                    // Ширина обводки в пикселях.
                    strokeWidth: 1
                },
                items: [

                ],
                placemarkCollection: null,
                circleCollection: null
            }
        ];

        function updateGeoPointsOnMap(list) {
            if(groups!=null && groups.length!=0) {
                groups[0].items.length=0;
                myMap.geoObjects.remove(groups[0].placemarkCollection);

                myMap.geoObjects.remove(groups[0].circleCollection);

            }
            for(var i=0; i<list.length; i++) {
                groups[0].items.push(list[i]);
            }
            refreshMAP();
        }

        /*]]>*/
    </script>

    <!--MAP CONFIGURE-->
    <script th:inline="javascript">
        /*<![CDATA[*/

        var zoomByClick = 14;

        var myMap;

        function recenterMap(xA,yA,zoom) {
            try{
                //check is zoom less then 
                myMap.setCenter([xA,yA], myMap.getZoom() < zoom ? zoom : myMap.getZoom(), {
                    checkZoomRange: true,
                    duration: 1000
                });
            } catch(e) {
                console.log(e.toString());
            }
        }

        function getGroupIndex(group) {
            switch (group) {
                case "GeoPoints":
                    return 0;
                    break;
                case "TasksOwner":
                    return 1;
                    break;
                case "TasksLocal":
                    return 2;
                    break;
                default:
                    console.log("Unknown type of Tasks for refresh!");
                    return -1;
                    break;
            }
        }

        function getCircleByCoords(group, x, y) {
            var groupIndex = getGroupIndex(group);

            var circle = null;
            try{
                var iterator = groups[groupIndex].circleCollection.getIterator(),
                    object, durind=0;
                while (object = iterator.getNext()) {
                    if (object.geometry.getCoordinates()[0]==x && object.geometry.getCoordinates()[1]==y) {
                        circle = groups[groupIndex].circleCollection.get(durind);
                        break;
                    }
                    durind++;
                }
            } catch (e){console.log(e.toString());}
            return circle;
        }

        function baloonTaskOpen(event, type) {
            var coords,
                durPlaceMark,
                circle;
            try{
                durPlaceMark = event.get('target');
                coords = durPlaceMark.geometry._coordinates;

                circle = getCircleByCoords(type, coords[0], coords[1]);

                replaceTaskContent(durPlaceMark['properties'].get('id'), coords[0], coords[1],
                    circle == null ? defaultGeoRadius :circle.geometry.getRadius());

                $("#sidebar-wrapper-right").toggleClass("active", true);

                setDisplayList("changeTaskForm",true);

            } catch (e){console.log(e.toString());}

            recenterMap(coords[0],coords[1],zoomByClick);

            setViewTaskButton();

            try{
                if(placemarkYour!=null){
                    placemarkYour.options._options.visible;

                    placemarkYour._options.visible;

                    placemarkYour.options.visible;

                    if(placemarkYour.options._options.visible == true) {
                        isTrustedClose = false;
                        placemarkYour.balloon.close();
                    }
                }

            }catch(e){console.log(e.toString())}

        }

        function refreshMAP() {
            for (var i = 0, l = groups.length; i < l; i++) {
                createMenuGroup(groups[i]);
            }
            function createMenuGroup (group) {
                // Коллекция для геообъектов группы.

                group.placemarkCollection = new ymaps.GeoObjectCollection({}, {
                    preset: group.style/*,
                    strokeWidth: 4,
                    geodesic: true*/
                });
                // Добавляем коллекцию на карту.
                myMap.geoObjects.add(group.placemarkCollection);

                // Коллекция для окружностей группы.
                group.circleCollection = new ymaps.GeoObjectCollection({}/*, {
                    preset: group.style,
                    strokeWidth: 4,
                    geodesic: true
                }*/);
                // Добавляем коллекцию на карту.
                myMap.geoObjects.add(group.circleCollection);

                for (var j = 0, m = group.items.length; j < m; j++) {
                    createSubMenu(group, group.items[j], group.placemarkCollection,group.circleCollection);
                }

                switch(group.name){
                    case "GeoPoints":
                        group.placemarkCollection.events
                            .add('mouseenter', function (e) {
                                try{
                                    // Ссылку на объект, вызвавший событие,
                                    // можно получить из поля 'target'.
                                    e.get('target').options.set('preset', 'twirl#storehouseIcon');
                                } catch (e) {console.log(e);}
                            })
                            .add('balloonopen', function (event) {
                                // ваши действия
                                // myMap.balloon.close();
                                // event.get('target').ballon.open();
//                this.coords;
//                var coords = event.get('coords');
                                var coords,
                                    durPlaceMark,
                                    circle;
                                try{
//                                    durPlaceMark = event.originalEvent.target;
                                    durPlaceMark = event.get('target')
                                    coords = durPlaceMark.geometry._coordinates;

                                    circle = getCircleByCoords("GeoPoints", coords[0], coords[1]);

                                    refreshChangeGeoPointForm(
                                        durPlaceMark['properties'].get('id'),
                                        coords[0], coords[1],
                                        circle == null ? defaultGeoRadius : circle.geometry.getRadius(),
                                        durPlaceMark['properties'].get('balloonContent'),
                                        true);

                                    setDisplayList("addGeoPointForm",true);

                                } catch (e){console.log(e.toString());}

                                recenterMap(coords[0],coords[1],zoomByClick);
                                //UPDATE DELETE
                                setUpdateDeleteButtons();

                                try{
                                    if(placemarkYour!=null){
                                        placemarkYour.options._options.visible;

                                        placemarkYour._options.visible;

                                        placemarkYour.options.visible;

                                        if(placemarkYour.options._options.visible == true) {
                                            isTrustedClose = false;
                                            placemarkYour.balloon.close();
                                        }
                                    }

                                }catch(e){console.log(e.toString())}

                            })
                            .add('balloonclose', function (event) {
//                                if(!updating)
                                    closeChangingGeoPoint();
                            });
                        break;
                    case "TasksOwner":
                    case "TasksLocal":
                        group.placemarkCollection.events.add('mouseenter', function (e) {
                            try{
                                // Ссылку на объект, вызвавший событие,
                                // можно получить из поля 'target'.
                                e.get('target').options.set('preset', 'islands#whiteIcon');
                            } catch (e) {console.log(e);}
                        })
                        .add('balloonopen', function (event) {

                            baloonTaskOpen(event, group.name);

                        })
                        .add('balloonclose', function (event) {
                            closeChangingTask();
                        });
                        break;
                    default:
                        console.log("Unknown type refresh Map!")
                        return;
                        break;
                }
                group.placemarkCollection.events.add('mouseleave', function (e) {
                    try{
                        e.get('target').options.unset('preset');
                    } catch (e) {console.log(e);}
                });

            }

            function createSubMenu (group, item, placemarkCollection, circleCollection) {
                //// ID FROM item.id  CHECK
                var placemark = new ymaps.Placemark([item.latitude, item.longitude],{id: item.id}, { balloonContent: item.name});

                var newContent;
                try{
                    ymaps.geocode(placemark.geometry.getCoordinates(), {
                        results: 1
                    }).then(function (res) {
                        newContent = res.geoObjects.get(0) ?
                            res.geoObjects.get(0).properties.get('name') :
                            'Не удалось определить адрес.';

                        // Задаем новое содержимое балуна в соответствующее свойство метки.
                        switch (getGroupIndex(group.name)) {
                            case 0:
                                placemark.properties.set('balloonContent', item.descr==null||item.descr==="" ? "Адрес: " + newContent : item.descr);
                                break;
                            case 1:
                                placemark.properties.set('balloonContent', item.theme==null||item.theme==="" ? "Адрес: " + newContent : item.theme);
                                break;
                        }
                    });
                }catch(e){console.log(e.toString())}
                // Добавляем метку в коллекцию.
                placemarkCollection.add(placemark);

//                // Создаем экземпляр класса геометрии круга (указываем координаты и радиус в метрах).
//                var circleGeometry = new ymaps.geometry.Circle([item.latitude, item.longitude], item.radius),
//                // Создаем экземпляр класса геообъекта и передаем нашу геометрию в конструктор.
//                    circleGeoObject = new ymaps.GeoObject({ geometry: circleGeometry });

                var circleGeoObject = new ymaps.Circle(
                    [
                        [item.latitude, item.longitude], item.radius
                    ],
                    {
                        // Описываем свойства круга.
                        // Содержимое балуна.
                        //                        balloonContent: "Радиус круга - 10 км",
                        // Содержимое хинта.
                        //                        hintContent: "Подвинь меня"
                    }, {
                        // Задаем опции круга.
                        // Включаем возможность перетаскивания круга.
                        //                        draggable: true,
                        // Цвет заливки.
                        // Последний байт (77) определяет прозрачность.
                        // Прозрачность заливки также можно задать используя опцию "fillOpacity".
                        fillColor: group.styleCircle.fillColor,
                        // Прозрачность заливки.
                        fillOpacity: group.styleCircle.fillOpacity,
                        // Цвет обводки.
                        strokeColor: group.styleCircle.strokeColor,
                        // Прозрачность обводки.
                        strokeOpacity: group.styleCircle.strokeOpacity,
                        // Ширина обводки в пикселях.
                        strokeWidth: group.styleCircle.strokeWidth
                    }
                );

                // Добавляем окружность в коллекцию.
                circleCollection.add(circleGeoObject);

            }
        }

        function closeEditForms() {
            closeChangingGeoPoint();

            closeChangingTask();

            //closeeditRoute
        }

        var placemarkYour, circleYour, isTrustedClose = true;

        ymaps.ready(function () {
            // Создание экземпляра карты.
            if(ymaps==null){alert("Can't connect to maps")}
            myMap = new ymaps.Map('map', {
                    center: [59.93, 30.32],
                    zoom: 13
                }, {
                    searchControlProvider: 'yandex#search'
                });
            //Getting list of geopoints
            if($('#geoPointListBlock').children().length==0) {
                refreshGeoPointsList();
            }

        /*    var yellowCollection = new ymaps.GeoObjectCollection(null, {
                    preset: 'islands#yellowIcon'
                }),
                blueCollection = new ymaps.GeoObjectCollection(null, {
                    preset: 'islands#blueIcon'
                }),
                // Создаём макет содержимого.
                MyIconContentLayout = ymaps.templateLayoutFactory.createClass(
                    '<div style="color: #FFFFFF; font-weight: bold;">$[properties.iconContent]</div>'
                ),*/
        /*var myPlacemark = new ymaps.Placemark(myMap.getCenter(), {
                hintContent: 'Собственный значок метки',
                balloonContent: 'Это красивая метка'
            }, {
                // Опции.
                // Необходимо указать данный тип макета.
                                        iconLayout: 'default#image'
                //,
                //                         Своё изображение иконки метки.
                //                        iconImageHref: 'images/myIcon.gif',
                // Размеры метки.
                //                        iconImageSize: [30, 42],
                // Смещение левого верхнего угла иконки относительно
                // её "ножки" (точки привязки).
                //                        iconImageOffset: [-5, -38]
            });*/
        /*,
            myPlacemarkWithContent = new ymaps.Placemark([55.661574, 37.573856], {
                hintContent: 'Собственный значок метки с контентом',
                balloonContent: 'А эта — новогодняя',
                iconContent: '12'
            }, {
                // Опции.
                // Необходимо указать данный тип макета.
                iconLayout: 'default#imageWithContent',
                // Своё изображение иконки метки.
                //                        iconImageHref: 'images/ball.png',
                // Размеры метки.
                //                        iconImageSize: [48, 48],
                // Смещение левого верхнего угла иконки относительно
                // её "ножки" (точки привязки).
                //                        iconImageOffset: [-24, -24],
                // Смещение слоя с содержимым относительно слоя с картинкой.
                //                        iconContentOffset: [15, 15],
                // Макет содержимого.
                iconContentLayout: MyIconContentLayout
            })
            ,
            yellowCoords = [[55.73, 37.75], [55.81, 37.75]],
            blueCoords = [[55.73, 37.65], [55.81, 37.65]];


        for (var i = 0, l = yellowCoords.length; i < l; i++) {
            yellowCollection.save(new ymaps.Placemark(yellowCoords[i]));
        }
        for (var i = 0, l = blueCoords.length; i < l; i++) {
            blueCollection.save(new ymaps.Placemark(blueCoords[i]));
        }

        myMap.geoObjects.save(yellowCollection).save(blueCollection);
        */
        /*myMap.geoObjects
        .add(myPlacemark);
        .save(myPlacemarkWithContent);*/

            function hideYourPlaceholder() {
                if(placemarkYour==null||placemarkYour.options._options.visible == false) {
                    console.log("ERROR with YourPlacemark");
                    return;
                }
                try{
//                    placemarkYour.balloon.close();
                    placemarkYour.options.set('visible', false);
                    placemarkYour.properties.set('balloonContent',  "");

                    circleYour.geometry.setRadius(defaultGeoRadius);
                    circleYour.options.set('visible', false);
                }catch(e){console.log(e.toString())}
            }

            function createYourTappedPoint(coords) {

                // Создаем метку.
                placemarkYour = new ymaps.Placemark([coords[0].toPrecision(6), coords[1].toPrecision(6)], {
                    // balloonContent: '<img src="http://img-fotki.yandex.ru/get/6114/82599242.2d6/0_88b97_ec425cf5_M" />',
                    iconContent: "Новое"
                }, {
                    preset: "islands#greenStretchyIcon",
                    // Отключаем кнопку закрытия балуна.
//                            balloonCloseButton: false,
                    // Балун будем открывать и закрывать кликом по иконке метки.
                    hideIconOnBalloonOpen: false
                });

//                // Создаем экземпляр класса геометрии круга (указываем координаты и радиус в метрах).
//                var circleGeometry = new ymaps.geometry.Circle([coords[0].toPrecision(6), coords[1].toPrecision(6)], defaultGeoRadius);
//                // Создаем экземпляр класса геообъекта и передаем нашу геометрию в конструктор.
//                circleYour = new ymaps.GeoObject({ geometry: circleGeometry });

                circleYour = new ymaps.Circle(
                    [
                        [coords[0].toPrecision(6), coords[1].toPrecision(6)], defaultGeoRadius
                    ],
                    {
                        // Описываем свойства круга.
                        // Содержимое балуна.
                        //                        balloonContent: "Радиус круга - 10 км",
                        // Содержимое хинта.
                        //                        hintContent: "Подвинь меня"
                    }, {
                        // Задаем опции круга.
                        // Включаем возможность перетаскивания круга.
                        //                        draggable: true,
                        // Цвет заливки.
                        // Последний байт (77) определяет прозрачность.
                        // Прозрачность заливки также можно задать используя опцию "fillOpacity".
                        fillColor: "#27bb47",
                        // Прозрачность заливки.
                        fillOpacity: 0.3,
                        // Цвет обводки.
                        strokeColor: "#67e250",
                        // Прозрачность обводки.
                        strokeOpacity: 0.5,
                        // Ширина обводки в пикселях.
                        strokeWidth: 1
                    }
                );

                /*Refresh form on OPENING BALOON*/
                placemarkYour.events.add('balloonopen',function (e) {
                    e.preventDefault();
                    console.log("your baloon opened");
                    var coords = placemarkYour.geometry.getCoordinates();
                    try {
                        refreshChangeGeoPointForm(-1,
                            coords[0],
                            coords[1],
                            circleYour == null ? defaultGeoRadius :circleYour.geometry.getRadius(),
                            placemarkYour['properties'].get('balloonContent'),
                            true);

                        replaceTaskContent(placemarkYour.id, coords[0], coords[1],
                            circleYour == null ? defaultGeoRadius :circleYour.geometry.getRadius());

                        messageToAddPlace();


                    } catch (e) {
                        console.log(e);
                    }
                    recenterMap(coords[0],coords[1],zoomByClick);
                    setCreateCancelButtons();
                    setCreateTaskButton();
                });

                /*HIDE PLACEMARK ON CLOSING BALOON*/
                placemarkYour.events.add('balloonclose',function (e) {
                    e.preventDefault();
                    console.log("your baloon closed");
                    hideYourPlaceholder();

                    if(isTrustedClose) {
                        closeEditForms();
                        return;
                    }
                    isTrustedClose = true;
                });

                myMap.geoObjects.add(placemarkYour);
                myMap.geoObjects.add(circleYour);


            }

            // Обработка события, возникающего при щелчке
            // левой кнопкой мыши в любой точке карты.
            // При возникновении такого события откроем балун.
            myMap.events.add('click', function (e) {
                if (!myMap.balloon.isOpen() && (placemarkYour == null || placemarkYour.options._options.visible == false)) {
                    var coords = e.get('coords');

                    if(placemarkYour==null&&circleYour==null){

                        createYourTappedPoint(coords);

                    }else{
                        placemarkYour.geometry.setCoordinates([coords[0].toPrecision(6), coords[1].toPrecision(6)]);
                        placemarkYour.options.set('visible', true)

                        circleYour.geometry.setCoordinates([coords[0].toPrecision(6), coords[1].toPrecision(6)]);
                        circleYour.options.set('visible', true)
                    }

                    var newContent;
                    try{
                        ymaps.geocode(placemarkYour.geometry.getCoordinates(), {
                            results: 1
                        }).then(function (res) {
                            newContent = res.geoObjects.get(0) ?
                                res.geoObjects.get(0).properties.get('name') :
                                'Не удалось определить адрес.';

                            // Задаем новое содержимое балуна в соответствующее свойство метки.
                            placemarkYour.properties.set('balloonContent',  newContent);
//                            placemarkYour.balloon.setData({ content: ''+newContent });
                        });
                    }catch(e){console.log(e.toString())}
//                    console.log(placemarkYour.properties.get('balloonContent'));
                    console.log(placemarkYour['properties'].get('balloonContent'));

                    //placemarkYour.balloon.open();
                }
                else {
                    myMap.balloon.close();
                    /*hideYourPlaceholder();*/
                }
            });

        });
        /*]]>*/
    </script>
</div>

<!--WRAPPER MENUS-->
<div th:replace="fragments/wrappermenu :: wrappermenu"> </div>

<!--EVENTS LISTS IN LEFT MENU-->
<script th:inline="javascript">
    // <![CDATA[

    function toggleList(elemName) {
        switch (elemName){
            case "geoPointList":
                $('#geoPointListBlock').toggle("fast");
                break;
            case "routeList":
                break;
            case "tasksList":
                $('#tasksBlock').toggle("fast");
                break;
            case "addGeoPointForm":
                $('#add-geo_point-form').toggle("fast");
                break;
            case "changeTaskForm":
                $('#change-task-form').toggle("fast");
                break;
        }
    }

    function setDisplayList(elemName,bool) {
        if(bool===true){
            switch (elemName){
                case "geoPointList":
                    $('#geoPointListBlock').show("fast");
                    break;
                case "routeList":
                    break;
                case "myTaskList":
                    break;
                case "addGeoPointForm":
                    $('#add-geo_point-form').show("fast");
                    break;
                case "changeTaskForm":
                    $('#change-task-form').show("fast");
                    break;
            }
        } else if(bool===false) {
            switch (elemName){
                case "geoPointList":
                    $('#geoPointListBlock').hide("fast");
                    break;
                case "routeList":
                    break;
                case "myTaskList":
                    break;
                case "addGeoPointForm":
                    $('#add-geo_point-form').hide("fast");
                    break;
                case "changeTaskForm":
                    $('#change-task-form').hide("fast");
                    break;
            }
        }

    }

    $(document).ready(function() {
        $('#changeGeoPointsButton').click(function (e) {
            toggleList("addGeoPointForm");
        });

        $('#getGeoPointsButton').click(function (e) {

            if($('#geoPointListBlock').children().length==0){
                refreshGeoPointsList();
            }

//            $(this).off("click").click(function (e) {
                toggleList("geoPointList");
//            });
        });

        $('#getTasksListButton').click(function (e) {
            toggleList("tasksList");
        });

        $('#getTasksOwnerButton').click(function (e) {
            if($('#TasksOwnerListBlock').children().length==0){
                refreshTasksList("TasksOwner");
            }
        });

        $('#getTasksLocalButton').click(function (e) {
            if($('#TasksOwnerListBlock').children().length==0){
                refreshTasksList("TasksLocal");
            }
        });

    });

</script>

<!--RESPONSE FROM CRUD-->
<div id="responseBlock" class="Message is-hidden">
    <span id="responseMessage"></span>
</div>

<!--MESSAGES-->
<div id="message-add_place" class="Message is-hidden">
    <div class="Message-icon">
        <i class="fa fa-bell-o"></i>
    </div>
    <div class="Message-body">
        <p>Выберите место для дальнейшего действия!
            <small><br>Добавьте новое место или задание!</small>
        </p>
        <button class="Message-button" id="js-showMeGeo">Добавить место!</button>
        <button class="Message-button" id="js-showMeTask">Добавить задание!</button>
    </div>
    <button class="Message-close js-messageClose"><i class="fa fa-times"></i></button>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    function closeMessage(el) {
        el.addClass('is-hidden');
    }

    function messageToAddPlace() {
        var mes = $('#message-add_place');
        mes.removeClass('is-hidden');
        setTimeout(function() {
            closeMessage(mes);
        }, 10000);
    }

    $(document).ready(function() {
        $('.js-messageClose').on('click', function(e) {
            closeMessage($(this).closest('.Message'));
            setDisplayList("addGeoPointForm",false);
            setDisplayList("changeTaskForm",false);
        });

        $('#js-showMeGeo').on('click', function(e) {
            $("#sidebar-wrapper-right").toggleClass("active", true);
            setCreateCancelButtons();
            setCreateTaskButton();
            setDisplayList("addGeoPointForm",true);
            closeMessage($(this).closest('.Message'));
        });

        $('#js-showMeTask').on('click', function(e) {
            $("#sidebar-wrapper-right").toggleClass("active", true);
            setCreateTaskButton();
            setCreateCancelButtons();
            setDisplayList("changeTaskForm",true);
            closeMessage($(this).closest('.Message'));
        });
    });
    /*]]*/
</script>

<!--GEOPOINTS CRUD + BUTTONS GEOFORM-->
<script th:inline="javascript">
    // <![CDATA[

    var createUpdateGeoButton;
    var deleteCancelGeoButton;
    var defaultGeoRadius = 300;

    $(document).ready(function() {
        createUpdateGeoButton = $("#geo_point-create_update-button");
        deleteCancelGeoButton = $("#geo_point-delete_cancel-button");
        createViewTaskButton = $("#task-create_view-button");
    });

    function setCreateCancelButtons() {
//        $(createUpdateGeoButton).prop('value', 'Create');
//        $(deleteCancelGeoButton).prop('value', 'Cancel');
        $(createUpdateGeoButton).html('Создать');
        $(deleteCancelGeoButton).html('Отменить');

        $(createUpdateGeoButton).prop("type", "submit");
        $(deleteCancelGeoButton).prop("type", "button");

        $(createUpdateGeoButton).off("click").click(function (e) {
            e.preventDefault();
            submitCreateGeoPoint();
//            submitGeoPointForm(/*[[@{/secure/geopoint/create}]]*/'/secure/geopoint/create','POST');
//            submitGeoPointForm(/*[[@{/secure/api/geo/byEmail}]]*/'/secure/api/geo/byEmail','POST');
        });
        $(deleteCancelGeoButton).off("click").click(function (e) {
            e.preventDefault();
            closeChangingGeoPoint();
        });
    }

    function setUpdateDeleteButtons() {
//        $(createUpdateGeoButton).prop('value', 'Update');
//        $(deleteCancelGeoButton).prop('value', 'Delete');
//        createUpdateGeoButton.textContent = "Update";
//        deleteCancelGeoButton.textContent = "Delete";
        $(createUpdateGeoButton).html('Обновить');
        $(deleteCancelGeoButton).html('Удалить');

        $(createUpdateGeoButton).prop("type", "submit");
        $(deleteCancelGeoButton).prop("type", "submit");

        $(createUpdateGeoButton).off("click").click(function (e) {
            e.preventDefault();
            submitUpdateGeoPoint();
//            submitGeoPointForm(/*[[@{/secure/geopoint/update}]]*/'/secure/geopoint/update','PATCH');
//            submitGeoPointForm(/*[[@{/secure/api/geo}]]*/'/secure/api/geo','PATCH');
        });
        $(deleteCancelGeoButton).off("click").click(function (e) {
            e.preventDefault();
            submitDeleteGeoPoint();
//            submitGeoPointForm(/*[[@{/secure/api/geo/byObj}]]*/'/secure/api/geo/byObj','DELETE');
        });
    }


    function getData() {
        var data = {}
        data["id"] = $("#input-geo_point-id").val();
        data["descr"] = $("#input-geo_point-descr").val();
        data["latitude"] = $("#input-geo_point-latitude").val();
        data["longitude"] = $("#input-geo_point-longitude").val();
        data["radius"] = $("#input-geo_point-radius").val();
        return data;
    }

    function submitCreateGeoPoint() {
        var action =/*[[@{/secure/api/geo}]]*/'/secure/api/geo';

        console.log('ajax submitGeoPointForm()');

        var data = getData();
/*try{
    frmjs = JSON.stringify(data);
}catch(e){console.log(e)}*/
        $.ajax({
            url: action,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            timeout: 600000,
            async: true,
            beforeSend: function(request) {
                request.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success: function (response) {
                // if the response contains any errors, replace the form
                if ($(response).find('.has-error').length) {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                } else {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                    refreshGeoPointsList();

                    //                    isTrustedClose = false;
                    placemarkYour.balloon.close();
                }
            },
            error :function(response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
                $("#responseMessage").text(response.message);
                $("#responseMessage").show('slow');
                $("#responseMessage").hide('slow');
            }
        });

    }

    function submitUpdateGeoPoint() {
        var url = /*[[@{/secure/api/geo}]]*/'/secure/api/geo';
        console.log('ajax submitGeoPointForm()');

        var data = getData();
        /*try{
            frmjs = JSON.stringify(data);
            frmjs = data.serialize();
        }catch(e){console.log(e)}*/
        $.ajax({
            url: url,
            type: 'PATCH',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            timeout: 600000,
            async: true,
            beforeSend: function(request) {
                request.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success: function (response) {
                // if the response contains any errors, replace the form
                if ($(response).find('.has-error').length) {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                } else {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                    refreshGeoPointsList();
                }
            },
            error :function(response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
                $("#responseMessage").text(response.message);
                $("#responseMessage").show('slow');
                $("#responseMessage").hide('slow');
            }
        });

    }

    function submitDeleteGeoPoint() {
        var url = /*[[@{/secure/api/geo?id=}]]*/'/secure/api/geo?id=';
            url += $('#input-geo_point-id').val();

        $.ajax({
            type : "DELETE",
            url : url,
            data: {},
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            timeout: 600000,
            async: true,
            beforeSend: function(request) {
                request.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success : function(response) {
                if ($(response).find('.has-error').length) {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                } else {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                    refreshGeoPointsList();
                }
            },
            error :function(response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
                $("#responseMessage").text(response.message);
                $("#responseMessage").show('slow');
                $("#responseMessage").hide('slow');
            }
        });
    }

    function submitGeoPointForm(action,type){

        var form = $('#geo_point-form');
        $(form).attr("action", action);
        $(form).attr("method", type);

        console.log('ajax submitGeoPointForm()');

        var frmjs = form.serialize();
        //frmjs = JSON.stringify(form);

        $.ajax({
            url: action,
            type: type,
            contentType: "application/json",

            data: type!="PATCH" ? form.serialize():{status: form.serialize(), _method: "PATCH"},
//            data: JSON.stringify(data),
            dataType: "json",
            timeout: 600000,
            async: true,
            beforeSend: function(request) {
                request.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success: function (response) {
                // if the response contains any errors, replace the form
                if ($(response).find('.has-error').length) {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                } else {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');
                }
            },
//            error :function(XMLHttpRequest, textStatus, errorThrown) {
            error :function(response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
                $("#responseMessage").text(response);
                $("#responseMessage").show('slow');
                $("#responseMessage").hide('slow');
            }
        });

//        refreshGeoPointsList();
    }

    /*$(document).ready(function() {
        $('#input-geo_point-radius').on('onchange',function (e) {

        });
    });*/
    // ]]>
</script>

<!--GEOPOINTS LIST GET + GEO FORM-->
<script th:inline="javascript">
    /*<![CDATA[*/

    function refreshChangeGeoPointForm(id,x,y,R,T,bool) {

        document.getElementById('input-geo_point-id').value = id;
        document.getElementById('input-geo_point-latitude').value = x;
        document.getElementById('input-geo_point-longitude').value = y;
        document.getElementById('input-geo_point-radius').value = R;
        document.getElementById('input-geo_point-descr').value = T;

        $("#sidebar-wrapper-right").toggleClass("active", bool);

        $("#responseMessage").text('');

    }

    function closeChangingGeoPoint() {
        refreshChangeGeoPointForm(null,null,null,defaultGeoRadius,"",false);

        //CREATE CANCEL
        setCreateCancelButtons();

        setDisplayList("addGeoPointForm",false);
    }

    function filterListGeoResponse(response){
        var geoListBlock = $('#geoPointListBlock');
        var responseAsObject;

        responseAsObject = $.parseJSON(response);
        var htmlResponse;
        if(responseAsObject.length>0){
            htmlResponse = "<ul>";
            for(var i=0; i<responseAsObject.length; i++) {
                htmlResponse+="<li class='elem-geoPointFromList'>";
                htmlResponse+="<span id='geo_point-id-in-list-"+i+"' style='display:none;'>";
                htmlResponse+= responseAsObject[i].id+"</span>";
                htmlResponse+= "Info "+responseAsObject[i].descr==null||responseAsObject[i].descr==""?"Моё место":responseAsObject[i].descr
                htmlResponse+= "<br>"+
                    "latitude "+responseAsObject[i].latitude+"<br>"+
                    "longitude "+responseAsObject[i].longitude+"<br>"+
                    "radius "+responseAsObject[i].radius;
                htmlResponse+="</li>";
            }
            htmlResponse+="</ul>";
        } else {
            htmlResponse = "<div class='empty_list'>Добавьте часто посещаемые места</div>"
        }
        return [htmlResponse, responseAsObject];
    }

    function refreshGeoPointsList() {
        var url = /*[[@{/secure/api/geo/geoPointList}]]*/'/secure/api/geo/geoPointList';
/*
        $("#geoPointListBlock").load(url, function (response, status, xhr) {
            console.log('ajax refreshGeoPointsList()');
            if (status == "error") {
                var msg = "Sorry but there was an error: ";
                alert(msg + xhr.status + " " + xhr.statusText);
            } else if (status == "success") {
                var filteredresponse = filterListGeoResponse(response);
                response = filteredresponse[0];
                updateGeoPointsOnMap(filteredresponse[1]);
            }
        });*/

        $.ajax({
            type: "GET",
            dataType: 'html',
            url: url,
            error: function (response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
            },
            success: function (response) {
                var filteredresponse = filterListGeoResponse(response);

                $("#geoPointListBlock").html(filteredresponse[0]);

                updateGeoPointsOnMap(filteredresponse[1]);
            }
        });
    }

    // ]]>
</script>


<!--TASKS BUTTONS-->
<script th:inline="javascript">
    // <![CDATA[
    function replaceTaskContent(id,latitude,longitude,radius) {
        document.getElementById('input-task-id').value = id;
        try{
            document.getElementById('input-task-latitude').value = latitude;
            document.getElementById('input-task-longitude').value = longitude;
            document.getElementById('input-task-radius').value = radius;
        } catch (e) {console.log(e.toString());}
    }
     /*var changeTaskFormData, viewTaskButton;

    $(document).ready(function() {
        changeTaskFormData = $("#change-task-form-data");
        viewTaskButton = $("#task-view-button");
    });
    function setCreateTaskButton() {
        $(changeTaskFormData).show();
        $(viewTaskButton).hide();
    }

    function setViewTaskButton() {
        $(changeTaskFormData).hide();
        $(viewTaskButton).show();
    }*/

    var createViewTaskButton;

    $(document).ready(function() {
        createViewTaskButton = $("#task-create_view-button");
    });

    function setCreateTaskButton() {
        createViewTaskButton.html("Создать");

        $(createViewTaskButton).off("click").click(function (e) {
            e.preventDefault();
            submitCreateTask();
        });
    }

    function setViewTaskButton() {
        createViewTaskButton.html("Просмотреть");

        $(createViewTaskButton).off("click").click(function (e) {
            e.preventDefault();
            submitViewTask();
        });
    }

    function submitViewTask() {
        var action =/*[[@{/secure/task/}]]*/'/secure/task/';
        action += $('#input-task-id').val();

//        var form = $('#change-task-form-data');
//        form.action = action;
//        $(form).attr("method", "GET");

        window.location.href = action;
    }

    function submitCreateTask() {
        var action =/*[[@{/secure/task/form/withGeo}]]*/'/secure/task/form/withGeo';

//        var form = $('#change-task-form-data');
//        form.action = action;
//        $(form).attr("method", "POST");

        console.log('ajax submitGeoPointForm()');

        var data = getData();
        /*try{
         frmjs = JSON.stringify(data);
         }catch(e){console.log(e)}*/
        $.ajax({
            url: action,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            timeout: 600000,
            async: true,
            beforeSend: function(request) {
                request.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success: function (response) {

                // if the response contains any errors, replace the form
                if ($(response).find('.has-error').length) {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');

                } else {
                    $("#responseMessage").text(response.message);
                    $("#responseMessage").show('slow');
                    $("#responseMessage").hide('slow');

//                    refreshTasksOwnerList();

//                    isTrustedClose = false;
                    placemarkYour.balloon.close();

                    $('body').replaceWith(response);
//                    $('html').replaceWith(response);
//                    window.location.href = "secure/taskform/withGeo";
                    window.history.pushState("", "", "secure/taskform/withGeo");
                }
            },
            error :function(response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
                $("#responseMessage").text(response.message);
            }
        });

    }

    function closeChangingTask() {
        setDisplayList("changeTaskForm",false);
        setCreateTaskButton();
    }

    $('#changeTasksButton').click(function (e) {
        toggleList("changeTaskForm");
    });

    $("#task-cancel-button").click(function (e) {
        closeEditForms();

        $("#sidebar-wrapper-right").toggleClass("active", false);

//        placemarkYour.balloon.close();
    });

    // ]]>
</script>
<!--TASKS-->
<script th:inline="javascript">
    // <![CDATA[

    function filterListTasksOwnerResponse(type, response){
//        var tasksBlock = $('#tasksListBlock');
        var responseAsObject;

        responseAsObject = $.parseJSON(response);
        var htmlResponse;
        if(responseAsObject.length>0){
            htmlResponse = "<ul>";
            for(var i=0; i<responseAsObject.length; i++) {
                htmlResponse+="<li class='elem-"+type+"FromList'>";
                htmlResponse+="<span id='tasks_"+type+"-id-in-list-"+i+"' style='display:none;'>";
                htmlResponse+= responseAsObject[i].id+"</span>";
                htmlResponse+= "Theme "+responseAsObject[i].theme==null||responseAsObject[i].theme==""?"Задание":responseAsObject[i].theme
                htmlResponse+= "<br>"+
                    "descr     "+responseAsObject[i].descr+"<br>"+
                    "type      "+responseAsObject[i].type+"<br>"+
                    "latitude  "+responseAsObject[i].latitude+"<br>"+
                    "longitude "+responseAsObject[i].longitude+"<br>"+
                    "radius    "+responseAsObject[i].radius;
                htmlResponse+="</li>";
            }
            htmlResponse+="</ul>";
        } else {
            htmlResponse = "<div class='empty_list'>Добавьте своё задание!</div>"
        }
        return [htmlResponse, responseAsObject];
    }

    function refreshTasksList(type) {
        var url;
        switch (type) {
            case "TasksOwner":
                url = /*[[@{/secure/api/feed/10}]]*/'/secure/api/feed/10';
                break;
            case "TasksLocal":
                url = /*[[@{/secure/api/feed/30}]]*/'/secure/api/feed/30';
                break;
            default:
                console.log("Unknown type of Tasks for refresh!")
                return;
                break;
        }
        /*
         $("#geoPointListBlock").load(url, function (response, status, xhr) {
         console.log('ajax refreshGeoPointsList()');
         if (status == "error") {
         var msg = "Sorry but there was an error: ";
         alert(msg + xhr.status + " " + xhr.statusText);
         } else if (status == "success") {
         var filteredresponse = filterListGeoResponse(response);
         response = filteredresponse[0];
         updateGeoPointsOnMap(filteredresponse[1]);
         }
         });*/

        $.ajax({
            type: "GET",
            dataType: 'html',
            url: url,
            error: function (response) {
                var msg = "Sorry but there was an error: ";
                alert(msg+response.responseText);
            },
            success: function (response) {
                var filteredresponse = filterListTasksOwnerResponse(type, response);

                $("#tasksListBlock").html(filteredresponse[0]);

                updateTasksOnMap(type, filteredresponse[1]);
            }
        });
    }

    function updateTasksOnMap(type, list) {
        if(groups!=null && groups.length!=0) {
            var index = getGroupIndex(type);

            groups[index].items.length=0;
            myMap.geoObjects.remove(groups[index].placemarkCollection);

            myMap.geoObjects.remove(groups[index].circleCollection);

            for(var i=0; i<list.length; i++) {
                groups[index].items.push(list[i]);
            }

            refreshMAP();
        }
    }
    // ]]>
</script>

</body>
</html>